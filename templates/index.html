<!DOCTYPE html>
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Michroma&family=Montserrat:wght@600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="images/favicon-96x96.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="images/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="images/favicon-16x16.png"
    />
    <script defer="defer" src="../static/js/player.js"></script>

    <title>My App</title>
    <link rel="stylesheet" href="../static/css/app.css" />
    <link rel="stylesheet" href="../static/css/bootstrap.min.css" />
    <meta name="description" content="" />

    <meta property="og:title" content="" />
    <meta property="og:type" content="" />
    <meta property="og:url" content="" />
    <meta property="og:image" content="" />

    <link rel="icon" href="/img/favicon.ico" sizes="any" />
    <link rel="icon" href="/img/icon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="img/icon.png" />

    <link rel="manifest" href="site.webmanifest" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <meta name="theme-color" content="#fafafa" />
    <!--추가한 부분-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!---->
  </head>

  <body>
    <div class="flex flex-col h-screen">
      <header class="p-4 border-b">
        <div class="container flex items-center justify-between gap-50">
          <div class="flex items-center gap-2">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="w-8 h-8"
            >
              <path
                d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"
              ></path>
              <circle cx="12" cy="13" r="3"></circle></svg
            ><span class="text-xl font-bold">My App</span>
          </div>
          <div>
            <div class="form-floating">
              <select
                class="form-select"
                id="camera-select"
                aria-label="Floating label select example"
              ></select>
              <label for="camera-select">카메라 선택</label>
            </div>
            <button
              id="start-btn"
              class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-green-500 hover:text-accent-foreground h-9 rounded-md px-3 gap-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="w-4 h-4"
              >
                <path
                  d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"
                ></path>
                <circle cx="12" cy="13" r="3"></circle>
              </svg>
              Start</button
            ><button
              id="stop-btn"
              class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-red-500 hover:text-accent-foreground h-9 rounded-md px-3 gap-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="w-4 h-4"
              >
                <path
                  d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"
                ></path>
                <circle cx="12" cy="13" r="3"></circle>
              </svg>
              End
            </button>
          </div>
        </div>
      </header>
      <main class="flex flex-1 items-center justify-center">
        <div class="flex flex-row w-full p-4 gap-4">
          <div
            id="webcam-video"
            class="relative aspect-[16/9] overflow-hidden rounded-lg flex-1 border-4"
          >
            <img
              id="video-image"
              src="../static/img/webcam-default.png"
              width="1162"
              height="734"
              alt="Video"
              class="object-cover"
              style="
                aspect-ratio: 640 / 360;
                object-fit: cover;
                align-content: center;
              "
            />
            <!-- 추가한 부분 -->
            <div class="flex items-center">
              <form id="text-form" class="flex-grow flex items-center">
                <input
                  type="text"
                  class="bg-white border flex-grow p-2"
                  placeholder="원하는 단어를 입력하세요"
                  id="input-word"
                />
                <button
                  type="submit"
                  class="btn bg-blue-500 hover:bg-blue-700 text-white text-sm px-4"
                  id="search-box"
                >
                  Send
                </button>
              </form>
            </div>
            <!---->
          </div>
          <!-- 추가한 부분 -->
          <div class="flex flex-col flex-1">
            <div
              id="player-container"
              class="relative aspect-[16/9] overflow-hidden flex-1 rounded-lg border-4"
            ></div>
            <div
              id="player-text"
              class="mt-2 bg-gray-100 border border-gray-300 box-border rounded-lg text-center p-2 flex justify-between items-center"
            >
              <p class="flex-grow"></p>
              <button
                id="toggle-blur-btn"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold px-4 py-1 text-sm rounded"
              >
                가리기
              </button>
            </div>
          </div>
          <!---->
        </div>
      </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <script>
      var socket;
      const cameraSelect = document.getElementById("camera-select");
      var videoImage = document.getElementById("video-image");

      document
        .getElementById("start-btn")
        .addEventListener("click", function () {
          // 웹소켓 연결 시작
          if (!socket) {
            socket = io.connect("http://127.0.0.1:5000/web");

            socket.on("connect", function () {
              console.log("Connected to the server.");
            });

            socket.on("flash_border", function (data) {
              if (data.status === "confirmed") {
                const videoStream = document.getElementById("webcam-video");
                videoStream.style.border = "10px solid #00FF00";

                setTimeout(function () {
                  videoStream.style.border = "";
                }, 1000); // 1초 후에 테두리 색상을 원래래도
              }
            });

            // 추가한부분 -> 검색한 텍스트, 지피티의 응답 테스트 서버로부터 받아 화면에 표시
            socket.on("player_text", function (data) {
              document
                .getElementById("player-text")
                .querySelector("p").textContent = data.text;
            });
          }

          // 비디오 스트림 시작
          videoImage.src = "http://127.0.0.1:5000/video";
          videoImage.style.display = "block";
        });

      document
        .getElementById("stop-btn")
        .addEventListener("click", function () {
          // 웹소켓 연결 해제
          if (socket) {
            socket.disconnect();
            socket = null;
            console.log("Disconnected from the server.");
          }

          // 비디오 스트림 종료
          videoImage.src = "";
          videoImage.style.display = "none";
        });

      //카메라 선택
      navigator.mediaDevices.enumerateDevices().then((devices) => {
        const videoDevices = devices.filter(
          (device) => device.kind === "videoinput"
        );
        videoDevices.forEach((device) => {
          const option = document.createElement("option");
          option.value = device.deviceId;
          option.text = device.label || `Camera ${cameraSelect.length + 1}`;
          cameraSelect.appendChild(option);
        });
      });

      cameraSelect.onchange = () => {
        const selectedCameraIndex = cameraSelect.selectedIndex; // selectedIndex를 사용하여 선택된 카메라의 인덱스를 얻음

        fetch("/set_camera", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ cameraIndex: selectedCameraIndex }), // 카메라 인덱스를 서버로 전송
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Success:", data);
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      };
    </script>
    <script>
      //추가된 부분 > input 박스에 텍스트 입력시 서버로 텍스트 전송
      $(document).ready(function () {
        $("#text-form").on("submit", function (e) {
          e.preventDefault();

          var inputWord = $("#input-word").val();

          $.ajax({
            url: "http://127.0.0.1:5000/text-show",
            type: "POST",
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify({ text: inputWord }),
            success: function (response) {
              console.log("Success:", response);
              $("#input-word").val("");
            },
            error: function (xhr, status, error) {
              console.error("Error:", error);
            },
          });
        });
      });
    </script>
    <script>
      // 추가된 부분 > 가리기 버튼 클릭시 텍스트 블러 처리
      $(document).ready(function () {
        var blurEnabled = false; // 블러 상태를 추적하는 플래그

        $("#toggle-blur-btn").on("click", function () {
          if (blurEnabled) {
            $("#player-text").css("filter", ""); // 블러 제거
            blurEnabled = false;
          } else {
            $("#player-text").css("filter", "blur(5px)"); // 블러 적용
            blurEnabled = true;
          }
        });
      });
    </script>
  </body>
</html>
