<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Stream</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <script src="/static/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div id="top-bar">
        <button id="start-btn" type="button" class="custom-btn btn-3">START</button>
        <button id="stop-btn" type="button" class="custom-btn btn-7">STOP</button>
        <div class="camera-select">
            <label for="camera-select">카메라 선택:</label>
            <select id="camera-select">
            </select>
        </div>
    </div>
    <div class="video-container">
        <div id="webcam-video" class="video-feed">
            <img id="video-image" class="rounded mx-auto d-block" src="" alt="Video Stream" style="max-width: 100%; max-height: 100%;">
        </div>
        <div class="sidebar">
            <div class="video-virtual">가상인물 화면(비디오)</div>
            <div class="chat">
                <div class="chat-messages">채팅 화면</div>
                <input type="text" placeholder="메시지 입력...">
                <button>전송버튼</button>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <script type="text/javascript">
        var socket;
        const cameraSelect = document.getElementById('camera-select');
        var videoImage = document.getElementById('video-image');

        document.getElementById('start-btn').addEventListener('click', function() {
            // 웹소켓 연결 시작
            if (!socket) {
                socket = io.connect();

                socket.on('connect', function() {
                    console.log('Connected to the server.');
                });

                socket.on('flash_border', function(data) {
                    if(data.status === 'confirmed') {
                        const videoStream = document.getElementById('webcam-video');
                        videoStream.style.border = '10px solid #00FF00';

                        setTimeout(function() {
                            videoStream.style.border = '';
                        }, 1000); // 1초 후에 테두리 색상을 원래대로 돌립니다.

                        // 인식된 문자를 표시하는 요소의 내용을 업데이트합니다.
                        const recognizedTextElement = document.getElementById('recognized-text');
                        recognizedTextElement.textContent = '인식된 문자: ' + data.text + data.state;
                    }
                });
            }

            // 비디오 스트림 시작
            videoImage.src = "{{ url_for('camera_bp.video_feed') }}";
            videoImage.style.display = 'block';
        });

        document.getElementById('stop-btn').addEventListener('click', function() {
            // 웹소켓 연결 해제
            if (socket) {
                socket.disconnect();
                socket = null;
                console.log('Disconnected from the server.');
            }

            // 비디오 스트림 종료
            videoImage.src = "";
            videoImage.style.display = 'none';
        });

        //카메라 선택
        navigator.mediaDevices.enumerateDevices()
            .then(devices => {
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                videoDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${cameraSelect.length + 1}`;
                    cameraSelect.appendChild(option);
                });
            });

        cameraSelect.onchange = () => {
            const selectedCameraIndex = cameraSelect.selectedIndex; // selectedIndex를 사용하여 선택된 카메라의 인덱스를 얻음

            fetch('/set_camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ cameraIndex: selectedCameraIndex }), // 카메라 인덱스를 서버로 전송
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        };
    </script>
</body>
</html>
